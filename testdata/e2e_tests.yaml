read:
  - name: read password field
    args: [read, "op://Private/Test Login/password"]
    out: "secret123\n"

  - name: read username field
    args: [read, "op://Private/Test Login/username"]
    out: "testuser\n"

  - name: read credential field
    args: [read, "op://Private/Test API Key/credential"]
    out: "api-key-12345\n"

  - name: read sectioned field with section path
    args: [read, "op://Private/Test Sectioned/server/hostname"]
    out: "example.com\n"

  - name: read sectioned field without section (unambiguous)
    args: [read, "op://Private/Test Sectioned/hostname"]
    out: "example.com\n"

  - name: vault not found
    args: [read, "op://NoSuchVault/item/field"]
    err: "Error: vault not found: NoSuchVault\n"
    code: 1

  - name: item not found
    args: [read, "op://Private/NoSuchItem/field"]
    err: "Error: item not found: NoSuchItem\n"
    code: 1

  - name: field not found
    args: [read, "op://Private/Test Login/nosuchfield"]
    err: "Error: field not found: nosuchfield\n"
    code: 1

inject:
  # Braced references
  - name: braced reference with spaces
    args: [inject]
    stdin: "password={{ op://Private/Test Login/password }}"
    out: password=secret123

  - name: braced reference no spaces
    args: [inject]
    stdin: "password={{op://Private/Test Login/password}}"
    out: password=secret123

  # Bare references
  - name: bare reference
    args: [inject]
    stdin: "password=op://Private/Test Login/password"
    out: password=secret123

  - name: bare reference quote terminates
    args: [inject]
    stdin: '"op://Private/Test Login/password"'
    out: '"secret123"'

  - name: bare reference comma terminates
    args: [inject]
    stdin: "op://Private/Test Login/password,other"
    out: "secret123,other"

  - name: bare reference backslash terminates
    args: [inject]
    stdin: "op://Private/Test Login/password\\nother"
    out: "secret123\\nother"

  - name: bare reference newline terminates
    args: [inject]
    stdin: "op://Private/Test Login/password\nother"
    out: "secret123\nother"

  # Passthrough
  - name: no secrets passthrough
    args: [inject]
    stdin: No secrets here, just text
    out: No secrets here, just text

  # Multiple references
  - name: multiple references
    args: [inject]
    stdin: "user={{ op://Private/Test Login/username }} pass={{ op://Private/Test Login/password }}"
    out: user=testuser pass=secret123

  - name: same reference twice
    args: [inject]
    stdin: "a={{ op://Private/Test Login/password }} b={{ op://Private/Test Login/password }}"
    out: a=secret123 b=secret123

  - name: mixed braced and bare
    args: [inject]
    stdin: "a={{ op://Private/Test Login/username }} b=op://Private/Test Login/password"
    out: a=testuser b=secret123

  # Error cases
  - name: nonexistent item
    args: [inject]
    stdin: "{{ op://Private/nonexistent/field }}"
    err: "Error: failed to read op://Private/nonexistent/field: item not found: nonexistent\n"
    code: 1

  - name: nonexistent vault
    args: [inject]
    stdin: "{{ op://NoSuchVault/item/field }}"
    err: "Error: failed to read op://NoSuchVault/item/field: vault not found: NoSuchVault\n"
    code: 1

  - name: inject file
    args: [inject, -i, input.txt, -o, output.txt]
    files:
      input.txt: "password={{ op://Private/Test Login/password }}"
    outputs:
      output.txt:
        content: password=secret123
        mode: 0600

  - name: inject file with custom mode
    args: [inject, -i, input.txt, -o, output.txt, --file-mode, "0644"]
    files:
      input.txt: test
    outputs:
      output.txt:
        content: test
        mode: 0644

list:
  - name: list vaults
    args: [list]
    out: |
      Vaults:
        Private (vault-Private-uuid)
        Work (vault-Work-uuid)

run:
  # Basic functionality (use --no-masking to verify resolved values)
  - name: resolve env var secret reference
    args: [run, --no-masking, --, printenv, DB_PASSWORD]
    env:
      DB_PASSWORD: "op://Private/Test Login/password"
    out: "secret123\n"

  - name: resolve multiple env var secrets
    args: [run, --no-masking, --, sh, -c, "echo $DB_USER:$DB_PASS"]
    env:
      DB_USER: "op://Private/Test Login/username"
      DB_PASS: "op://Private/Test Login/password"
    out: "testuser:secret123\n"

  - name: passthrough non-secret env vars
    args: [run, --, printenv, PLAIN_VAR]
    env:
      PLAIN_VAR: "just-a-value"
    out: "just-a-value\n"

  - name: mixed secret and non-secret env vars
    args: [run, --no-masking, --, sh, -c, "echo $PLAIN:$SECRET"]
    env:
      PLAIN: "hello"
      SECRET: "op://Private/Test Login/password"
    out: "hello:secret123\n"

  # --env-file flag
  - name: env file basic
    args: [run, --no-masking, --env-file, .env, --, printenv, DB_PASSWORD]
    files:
      .env: "DB_PASSWORD=op://Private/Test Login/password"
    out: "secret123\n"

  - name: env file with spaces around equals
    args: [run, --no-masking, --env-file, .env, --, printenv, DB_PASSWORD]
    files:
      .env: "DB_PASSWORD = op://Private/Test Login/password"
    out: "secret123\n"

  - name: env file multiple vars
    args: [run, --no-masking, --env-file, .env, --, sh, -c, "echo $DB_USER:$DB_PASS"]
    files:
      .env: |
        DB_USER=op://Private/Test Login/username
        DB_PASS=op://Private/Test Login/password
    out: "testuser:secret123\n"

  - name: env file ignores comments and blank lines
    args: [run, --no-masking, --env-file, .env, --, printenv, DB_PASSWORD]
    files:
      .env: |
        # This is a comment

        DB_PASSWORD=op://Private/Test Login/password
        # Another comment
    out: "secret123\n"

  - name: env file overrides shell env
    args: [run, --no-masking, --env-file, .env, --, printenv, DB_PASSWORD]
    env:
      DB_PASSWORD: "op://Private/Test Login/username"
    files:
      .env: "DB_PASSWORD=op://Private/Test Login/password"
    out: "secret123\n"

  - name: multiple env files last wins
    args: [run, --no-masking, --env-file, .env1, --env-file, .env2, --, printenv, DB_PASSWORD]
    files:
      .env1: "DB_PASSWORD=op://Private/Test Login/username"
      .env2: "DB_PASSWORD=op://Private/Test Login/password"
    out: "secret123\n"

  # Variable substitution in secret references
  - name: variable substitution in reference
    args: [run, --no-masking, --env-file, .env, --, printenv, DB_PASSWORD]
    env:
      VAULT_NAME: "Private"
    files:
      .env: "DB_PASSWORD=op://$VAULT_NAME/Test Login/password"
    out: "secret123\n"

  - name: variable substitution multiple vars
    args: [run, --no-masking, --env-file, .env, --, printenv, CREDENTIAL]
    env:
      VAULT: "Private"
      ITEM: "Test API Key"
    files:
      .env: "CREDENTIAL=op://$VAULT/$ITEM/credential"
    out: "api-key-12345\n"

  # Masking
  - name: mask secrets in stdout
    args: [run, --, sh, -c, "echo secret123"]
    env:
      SECRET: "op://Private/Test Login/password"
    out: "<concealed>\n"

  - name: mask secret split across writes
    args: [run, --, sh, -c, "echo -n secre; sleep 0.01; echo t123"]
    env:
      SECRET: "op://Private/Test Login/password"
    out: "<concealed>\n"

  - name: empty secret value does not panic
    args: [run, --, echo, hello]
    env:
      EMPTY: "op://Private/Test Empty/empty"
    out: "hello\n"

  - name: no-masking shows secrets
    args: [run, --no-masking, --, sh, -c, "echo secret123"]
    env:
      SECRET: "op://Private/Test Login/password"
    out: "secret123\n"

  - name: mask multiple secrets
    args: [run, --, sh, -c, "echo secret123 and testuser"]
    env:
      PASS: "op://Private/Test Login/password"
      USER: "op://Private/Test Login/username"
    out: "<concealed> and <concealed>\n"

  - name: mask secrets in stderr
    args: [run, --, sh, -c, "echo secret123 >&2"]
    env:
      SECRET: "op://Private/Test Login/password"
    err: "<concealed>\n"

  # Error cases
  - name: vault not found
    args: [run, --, printenv, SECRET]
    env:
      SECRET: "op://NoSuchVault/item/field"
    err: "Error: failed to resolve SECRET: vault not found: NoSuchVault\n"
    code: 1

  - name: item not found
    args: [run, --, printenv, SECRET]
    env:
      SECRET: "op://Private/NoSuchItem/field"
    err: "Error: failed to resolve SECRET: item not found: NoSuchItem\n"
    code: 1

  - name: field not found
    args: [run, --, printenv, SECRET]
    env:
      SECRET: "op://Private/Test Login/nosuchfield"
    err: "Error: failed to resolve SECRET: field not found: nosuchfield\n"
    code: 1

  - name: env file not found
    args: [run, --env-file, nonexistent.env, --, echo, hi]
    errPrefix: "Error: failed to read env file nonexistent.env: "
    code: 1

  - name: command exit code propagates
    args: [run, --, sh, -c, "exit 42"]
    code: 42

  - name: no command provided
    args: [run]
    errPrefix: "Usage: opcli run [--env-file=<file>]... [--no-masking] -- <command>..."
    code: 1
